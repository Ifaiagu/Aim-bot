-- DaviBOT Hub Final v2
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")

-- Variáveis de controle
local AimbotEnabled = false
local AutoShootEnabled = false
local ESPEnabled = false
local TeamCheck = false
local AimPart = "Head"
local FOVSize = 100
local FOVColor = Color3.fromRGB(255, 255, 0)
local ESPColor = Color3.fromRGB(0, 255, 0)

-- FOV Circle
local FOVCircle = Drawing.new("Circle")
FOVCircle.Color = FOVColor
FOVCircle.Thickness = 1.5
FOVCircle.NumSides = 100
FOVCircle.Filled = false
FOVCircle.Radius = FOVSize
FOVCircle.Visible = true

-- Função de WallCheck
local function IsVisible(targetPart)
	local origin = Camera.CFrame.Position
	local direction = (targetPart.Position - origin)
	local result = workspace:Raycast(origin, direction, {LocalPlayer.Character, Camera})
	return not result or result.Instance:IsDescendantOf(targetPart.Parent)
end

-- Função para encontrar o inimigo mais próximo
local function GetClosestPlayer()
	local closestPlayer = nil
	local shortestDistance = math.huge
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character:FindFirstChild(AimPart) then
			if player.Character.Humanoid.Health > 0 then
				if not TeamCheck or player.Team ~= LocalPlayer.Team then
					local part = player.Character[AimPart]
					local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
					local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)).Magnitude
					if onScreen and dist < FOVSize and IsVisible(part) then
						if dist < shortestDistance then
							shortestDistance = dist
							closestPlayer = player
						end
					end
				end
			end
		end
	end
	return closestPlayer
end

-- ESP
local ESPObjects = {}
local function ClearESP()
	for _, v in pairs(ESPObjects) do
		if v.box then v.box:Remove() end
		if v.line then v.line:Remove() end
	end
	ESPObjects = {}
end

local function CreateESP(player)
	local box = Drawing.new("Square")
	box.Thickness = 1
	box.Filled = false
	box.Transparency = 1
	box.Color = ESPColor

	local line = Drawing.new("Line")
	line.Thickness = 1
	line.Transparency = 1
	line.Color = ESPColor

	ESPObjects[player] = {box = box, line = line}
end

local function UpdateESP()
	if not ESPEnabled then ClearESP() return end
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			if not ESPObjects[player] then
				CreateESP(player)
			end
			local hrp = player.Character.HumanoidRootPart
			local pos, onscreen = Camera:WorldToViewportPoint(hrp.Position)
			local boxObj = ESPObjects[player]
			if onscreen then
				local size = 50
				boxObj.box.Position = Vector2.new(pos.X - size/2, pos.Y - size)
				boxObj.box.Size = Vector2.new(size, size)
				boxObj.box.Visible = true

				boxObj.line.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
				boxObj.line.To = Vector2.new(pos.X, pos.Y)
				boxObj.line.Visible = true

				boxObj.box.Color = ESPColor
				boxObj.line.Color = ESPColor
			else
				boxObj.box.Visible = false
				boxObj.line.Visible = false
			end
		end
	end
end

-- Auto Shoot
RunService.RenderStepped:Connect(function()
	local target = GetClosestPlayer()
	FOVCircle.Radius = FOVSize
	FOVCircle.Color = FOVColor
	FOVCircle.Position = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)

	UpdateESP()

	if AimbotEnabled and target then
		local aimPos = target.Character[AimPart].Position
		Camera.CFrame = CFrame.new(Camera.CFrame.Position, aimPos)
		if AutoShootEnabled then
			VirtualUser:ClickButton1(Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2))
		end
	end
end)

-- Criação do HUB
local Window = Rayfield:CreateWindow({
	Name = "DaviBOT Hub",
	LoadingTitle = "DaviBOT Hub",
	LoadingSubtitle = "by David",
	ConfigurationSaving = {
		Enabled = true,
		FolderName = "DaviBOTHub",
		FileName = "DaviBOT_Config"
	},
	KeySystem = false
})

local MainTab = Window:CreateTab("Principal", 4483362458)

MainTab:CreateToggle({
	Name = "Aimbot",
	CurrentValue = false,
	Callback = function(Value)
		AimbotEnabled = Value
	end
})

MainTab:CreateToggle({
	Name = "Auto Shoot",
	CurrentValue = false,
	Callback = function(Value)
		AutoShootEnabled = Value
	end
})

MainTab:CreateToggle({
	Name = "ESP",
	CurrentValue = false,
	Callback = function(Value)
		ESPEnabled = Value
		if not Value then
			ClearESP()
		end
	end
})

MainTab:CreateDropdown({
	Name = "AimPart",
	Options = {"Head", "HumanoidRootPart"},
	CurrentOption = "Head",
	Callback = function(Option)
		AimPart = Option
	end
})

MainTab:CreateToggle({
	Name = "Team Check",
	CurrentValue = false,
	Callback = function(Value)
		TeamCheck = Value
	end
})

MainTab:CreateSlider({
	Name = "Tamanho do FOV",
	Range = {20, 300},
	Increment = 5,
	CurrentValue = 100,
	Callback = function(Value)
		FOVSize = Value
	end
})

MainTab:CreateColorPicker({
	Name = "Cor do FOV",
	Color = FOVColor,
	Callback = function(Color)
		FOVColor = Color
	end
})

MainTab:CreateColorPicker({
	Name = "Cor do ESP",
	Color = ESPColor,
	Callback = function(Color)
		ESPColor = Color
	end
})
